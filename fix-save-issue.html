<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ ä¿®å¤Save Settingsé—®é¢˜</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #cce7ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ä¿®å¤Save Settingsé—®é¢˜</h1>
    <p><strong>ç—‡çŠ¶</strong>: ç‚¹å‡»Saveæ˜¾ç¤º"auto digest disabled"ï¼Œæ•°æ®åº“ä¸­auto_digest_enabledè¿˜æ˜¯false</p>

    <!-- é…ç½® -->
    <div class="panel">
        <h3>âš™ï¸ é…ç½®</h3>
        <div class="form-group">
            <label>Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="ç®¡ç†å‘˜æƒé™ï¼Œç”¨äºä¿®å¤é—®é¢˜">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·ID:</label>
            <input type="text" id="userId" placeholder="å¯ä»¥ä»åº”ç”¨çš„æµè§ˆå™¨æ§åˆ¶å°è·å–">
        </div>
    </div>

    <!-- è¯Šæ–­é—®é¢˜ -->
    <div class="panel">
        <h3>ğŸ” å¿«é€Ÿè¯Šæ–­</h3>
        <button onclick="diagnoseIssue()">ğŸ” è¯Šæ–­é—®é¢˜</button>
        <div id="diagnoseStatus" class="status" style="display: none;"></div>
        <div id="diagnoseLog" class="log" style="display: none;"></div>
    </div>

    <!-- ç«‹å³ä¿®å¤ -->
    <div class="panel">
        <h3>âš¡ ç«‹å³ä¿®å¤</h3>
        <p>å¼ºåˆ¶è®¾ç½®auto_digest_enabled = true</p>
        <button onclick="fixNow()">ğŸ”§ ç«‹å³ä¿®å¤</button>
        <div id="fixStatus" class="status" style="display: none;"></div>
        <div id="fixLog" class="log" style="display: none;"></div>
    </div>

    <!-- RLSç­–ç•¥ä¿®å¤ -->
    <div class="panel">
        <h3>ğŸ”’ ä¿®å¤RLSç­–ç•¥</h3>
        <p>å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œè¿è¡Œè¿™ä¸ªSQLæ¥ä¿®å¤</p>
        <button onclick="generateRLSFix()">ğŸ“‹ ç”Ÿæˆä¿®å¤SQL</button>
        <div id="rlsStatus" class="status" style="display: none;"></div>
        <div id="rlsLog" class="log" style="display: none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ryncyvnezqwqqtfsweti.supabase.co';

        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // è¯Šæ–­é—®é¢˜
        window.diagnoseIssue = async function() {
            clearLog('diagnoseLog');
            try {
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!serviceKey) {
                    throw new Error('è¯·å¡«å†™Service Role Key');
                }

                if (!userId) {
                    addLog('diagnoseLog', 'æ²¡æœ‰æä¾›ç”¨æˆ·IDï¼Œå°è¯•æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·...');
                    
                    // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=id,email,auto_digest_enabled,auto_digest_time`, {
                        headers: {
                            'apikey': serviceKey,
                            'Authorization': `Bearer ${serviceKey}`
                        }
                    });

                    if (response.ok) {
                        const users = await response.json();
                        addLog('diagnoseLog', `æ‰¾åˆ° ${users.length} ä¸ªç”¨æˆ·:`);
                        users.forEach((user, index) => {
                            addLog('diagnoseLog', `${index + 1}. ID: ${user.id}`);
                            addLog('diagnoseLog', `   Email: ${user.email || 'N/A'}`);
                            addLog('diagnoseLog', `   Auto Digest: ${user.auto_digest_enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                            addLog('diagnoseLog', '');
                        });
                        
                        if (users.length > 0) {
                            document.getElementById('userId').value = users[0].id;
                            addLog('diagnoseLog', `å·²è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªç”¨æˆ·: ${users[0].id}`);
                        }
                    }
                    return;
                }

                addLog('diagnoseLog', `è¯Šæ–­ç”¨æˆ·: ${userId}`);

                // æŸ¥è¯¢ç‰¹å®šç”¨æˆ·
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=*&id=eq.${userId}`, {
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                if (users.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·');
                }

                const user = users[0];
                
                addLog('diagnoseLog', 'ç”¨æˆ·å½“å‰çŠ¶æ€:');
                addLog('diagnoseLog', `  ID: ${user.id}`);
                addLog('diagnoseLog', `  Email: ${user.email || 'N/A'}`);
                addLog('diagnoseLog', `  auto_digest_enabled: ${user.auto_digest_enabled}`);
                addLog('diagnoseLog', `  auto_digest_time: ${user.auto_digest_time || 'NULL'}`);
                addLog('diagnoseLog', `  auto_digest_timezone: ${user.auto_digest_timezone || 'NULL'}`);
                addLog('diagnoseLog', `  last_auto_digest_run: ${user.last_auto_digest_run || 'NULL'}`);
                addLog('diagnoseLog', `  updated_at: ${user.updated_at || 'NULL'}`);

                // è¯Šæ–­é—®é¢˜
                addLog('diagnoseLog', '\né—®é¢˜è¯Šæ–­:');
                
                if (user.auto_digest_enabled === null || user.auto_digest_enabled === undefined) {
                    addLog('diagnoseLog', 'âŒ auto_digest_enabledå­—æ®µä¸ºNULL - æ•°æ®åº“è¿ç§»å¯èƒ½æ²¡æœ‰æ­£ç¡®æ‰§è¡Œ');
                    showStatus('diagnoseStatus', 'error', 'âŒ æ•°æ®åº“å­—æ®µé—®é¢˜');
                } else if (user.auto_digest_enabled === false) {
                    addLog('diagnoseLog', 'âš ï¸ auto_digest_enabledä¸ºfalse - è¿™æ˜¯é—®é¢˜æ‰€åœ¨');
                    addLog('diagnoseLog', 'å¯èƒ½åŸå› :');
                    addLog('diagnoseLog', '1. RLSç­–ç•¥é˜»æ­¢ç”¨æˆ·æ›´æ–°');
                    addLog('diagnoseLog', '2. å‰ç«¯APIè°ƒç”¨å¤±è´¥');
                    addLog('diagnoseLog', '3. æ•°æ®æ ¼å¼é—®é¢˜');
                    showStatus('diagnoseStatus', 'warning', 'âš ï¸ éœ€è¦ä¿®å¤è®¾ç½®');
                } else {
                    addLog('diagnoseLog', 'âœ… auto_digest_enabledä¸ºtrue - è®¾ç½®æ­£ç¡®');
                    showStatus('diagnoseStatus', 'success', 'âœ… è®¾ç½®æ­£ç¡®');
                }

            } catch (error) {
                showStatus('diagnoseStatus', 'error', `âŒ è¯Šæ–­å¤±è´¥: ${error.message}`);
                addLog('diagnoseLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // ç«‹å³ä¿®å¤
        window.fixNow = async function() {
            clearLog('fixLog');
            try {
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!serviceKey || !userId) {
                    throw new Error('è¯·å¡«å†™Service Role Keyå’Œç”¨æˆ·ID');
                }

                addLog('fixLog', 'å¼€å§‹ä¿®å¤auto digestè®¾ç½®...');
                addLog('fixLog', `ç›®æ ‡ç”¨æˆ·: ${userId}`);

                // å¼ºåˆ¶æ›´æ–°è®¾ç½®
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        auto_digest_enabled: true,
                        auto_digest_time: '10:00:00',
                        auto_digest_timezone: 'UTC',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result && result.length > 0) {
                    const updatedUser = result[0];
                    showStatus('fixStatus', 'success', 'ğŸ‰ ä¿®å¤æˆåŠŸ!');
                    addLog('fixLog', 'âœ… è®¾ç½®å·²æˆåŠŸä¿®å¤:');
                    addLog('fixLog', `  auto_digest_enabled: ${updatedUser.auto_digest_enabled}`);
                    addLog('fixLog', `  auto_digest_time: ${updatedUser.auto_digest_time}`);
                    addLog('fixLog', `  updated_at: ${updatedUser.updated_at}`);
                    addLog('fixLog', '\nç°åœ¨å›åˆ°ä½ çš„åº”ç”¨ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ­£ç¡®çš„è®¾ç½®äº†!');
                } else {
                    throw new Error('æ›´æ–°æˆåŠŸä½†æ²¡æœ‰è¿”å›æ•°æ®');
                }

            } catch (error) {
                showStatus('fixStatus', 'error', `âŒ ä¿®å¤å¤±è´¥: ${error.message}`);
                addLog('fixLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // ç”ŸæˆRLSä¿®å¤SQL
        window.generateRLSFix = async function() {
            clearLog('rlsLog');
            
            addLog('rlsLog', 'å¦‚æœé—®é¢˜æ˜¯RLSæƒé™ï¼Œåœ¨Supabase Dashboardçš„SQLç¼–è¾‘å™¨ä¸­è¿è¡Œä»¥ä¸‹SQL:\n');
            
            addLog('rlsLog', '-- æ£€æŸ¥ç°æœ‰çš„RLSç­–ç•¥');
            addLog('rlsLog', "SELECT * FROM pg_policies WHERE tablename = 'users';\n");
            
            addLog('rlsLog', '-- å¦‚æœæ²¡æœ‰UPDATEç­–ç•¥ï¼Œåˆ›å»ºä¸€ä¸ª');
            addLog('rlsLog', 'CREATE POLICY "Users can update own record"');
            addLog('rlsLog', 'ON users FOR UPDATE');
            addLog('rlsLog', 'USING (auth.uid() = id);\n');
            
            addLog('rlsLog', '-- å¦‚æœæ²¡æœ‰SELECTç­–ç•¥ï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ª');
            addLog('rlsLog', 'CREATE POLICY "Users can view own record"');
            addLog('rlsLog', 'ON users FOR SELECT');
            addLog('rlsLog', 'USING (auth.uid() = id);\n');
            
            addLog('rlsLog', '-- ç¡®ä¿RLSå·²å¯ç”¨');
            addLog('rlsLog', 'ALTER TABLE users ENABLE ROW LEVEL SECURITY;\n');
            
            addLog('rlsLog', '-- æµ‹è¯•ç­–ç•¥æ˜¯å¦å·¥ä½œ');
            addLog('rlsLog', "SELECT current_setting('request.jwt.claims')::json ->> 'sub' as user_id;");
            
            showStatus('rlsStatus', 'info', 'ğŸ“‹ RLSä¿®å¤SQLå·²ç”Ÿæˆ');
        };

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            console.log('ğŸ’¡ æç¤º: å¦‚æœä¸çŸ¥é“ç”¨æˆ·IDï¼Œå¯ä»¥åœ¨ä½ çš„åº”ç”¨ä¸­æŒ‰F12ï¼Œåœ¨Consoleä¸­è¾“å…¥: console.log(supabase.auth.getUser())');
        };
    </script>
</body>
</html> 