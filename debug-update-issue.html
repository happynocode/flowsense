<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” è°ƒè¯•æ›´æ–°é—®é¢˜ - APIæˆåŠŸä½†æ•°æ®æœªæ›´æ–°</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #cce7ff; border: 1px solid #99d3ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 10px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è°ƒè¯•æ›´æ–°é—®é¢˜</h1>
    <p><strong>é—®é¢˜</strong>: APIè¿”å›200/204æˆåŠŸï¼Œä½†auto_digest_enabledä»ç„¶æ˜¯false</p>

    <!-- é…ç½® -->
    <div class="debug-panel">
        <h3>ğŸ“‹ é…ç½®</h3>
        <div class="form-group">
            <label>Supabase URL:</label>
            <input type="text" id="supabaseUrl" value="https://ryncyvnezqwqqtfsweti.supabase.co">
        </div>
        <div class="form-group">
            <label>Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="ç”¨äºç›´æ¥æ›´æ–°æ•°æ®åº“">
        </div>
        <div class="form-group">
            <label>ç”¨æˆ·ID:</label>
            <input type="text" id="userId" placeholder="ç›®æ ‡ç”¨æˆ·çš„ID">
        </div>
    </div>

    <!-- ä¸€é”®è§£å†³ -->
    <div class="debug-panel">
        <h3>âš¡ ä¸€é”®è§£å†³</h3>
        <p>ç›´æ¥ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¼ºåˆ¶æ›´æ–°ä½ çš„è®¾ç½®</p>
        <button onclick="forceUpdateNow()">ç«‹å³å¼ºåˆ¶æ›´æ–° auto_digest_enabled = true</button>
        <div id="forceStatus" class="status" style="display: none;"></div>
        <div id="forceLog" class="log" style="display: none;"></div>
    </div>

    <!-- æ­¥éª¤åŒ–è°ƒè¯• -->
    <div class="debug-panel">
        <h3>ğŸ” è¯¦ç»†è°ƒè¯•</h3>
        <button onclick="checkCurrentValue()">1. æ£€æŸ¥å½“å‰å€¼</button>
        <button onclick="testDirectUpdate()">2. æµ‹è¯•ç›´æ¥æ›´æ–°</button>
        <button onclick="verifyUpdate()">3. éªŒè¯æ›´æ–°ç»“æœ</button>
        <div id="debugStatus" class="status" style="display: none;"></div>
        <div id="debugLog" class="log" style="display: none;"></div>
    </div>

    <script>
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // ä¸€é”®å¼ºåˆ¶æ›´æ–°
        window.forceUpdateNow = async function() {
            clearLog('forceLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!url || !serviceKey) {
                    throw new Error('è¯·å¡«å†™Supabase URLå’ŒService Role Key');
                }

                if (!userId) {
                    throw new Error('è¯·å¡«å†™ç”¨æˆ·ID');
                }

                addLog('forceLog', 'å¼€å§‹å¼ºåˆ¶æ›´æ–°...');
                addLog('forceLog', `ç›®æ ‡ç”¨æˆ·ID: ${userId}`);

                // ç›´æ¥ä½¿ç”¨REST APIæ›´æ–°
                const response = await fetch(`${url}/rest/v1/users?id=eq.${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        auto_digest_enabled: true,
                        auto_digest_time: '10:00:00',
                        auto_digest_timezone: 'UTC',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                if (result && result.length > 0) {
                    showStatus('forceStatus', 'success', 'ğŸ‰ å¼ºåˆ¶æ›´æ–°æˆåŠŸ!');
                    addLog('forceLog', `æ›´æ–°æˆåŠŸ: auto_digest_enabled = ${result[0].auto_digest_enabled}`);
                    addLog('forceLog', `æ›´æ–°æ—¶é—´: ${result[0].auto_digest_time}`);
                    addLog('forceLog', 'ç°åœ¨å›åˆ°ä½ çš„åº”ç”¨ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ­£ç¡®çš„è®¾ç½®äº†!');
                } else {
                    throw new Error('æ›´æ–°æˆåŠŸä½†æ²¡æœ‰è¿”å›æ•°æ®');
                }

            } catch (error) {
                showStatus('forceStatus', 'error', `âŒ å¼ºåˆ¶æ›´æ–°å¤±è´¥: ${error.message}`);
                addLog('forceLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // æ£€æŸ¥å½“å‰å€¼
        window.checkCurrentValue = async function() {
            clearLog('debugLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                if (!url || !serviceKey || !userId) {
                    throw new Error('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ');
                }

                addLog('debugLog', 'æŸ¥è¯¢å½“å‰ç”¨æˆ·æ•°æ®...');

                const response = await fetch(`${url}/rest/v1/users?select=*&id=eq.${userId}`, {
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                if (users.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·');
                }

                const user = users[0];
                addLog('debugLog', `å½“å‰ç”¨æˆ·æ•°æ®:`);
                addLog('debugLog', `  auto_digest_enabled: ${user.auto_digest_enabled}`);
                addLog('debugLog', `  auto_digest_time: ${user.auto_digest_time}`);
                addLog('debugLog', `  auto_digest_timezone: ${user.auto_digest_timezone}`);
                addLog('debugLog', `  updated_at: ${user.updated_at}`);

                if (user.auto_digest_enabled === true) {
                    showStatus('debugStatus', 'success', 'âœ… å½“å‰å€¼å·²ç»æ˜¯true');
                } else {
                    showStatus('debugStatus', 'warning', 'âš ï¸ å½“å‰å€¼ç¡®å®æ˜¯false');
                }

            } catch (error) {
                showStatus('debugStatus', 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                addLog('debugLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // æµ‹è¯•ç›´æ¥æ›´æ–°
        window.testDirectUpdate = async function() {
            addLog('debugLog', '\n--- æµ‹è¯•ç›´æ¥æ›´æ–° ---');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;
                const userId = document.getElementById('userId').value;

                addLog('debugLog', 'æ‰§è¡Œç›´æ¥æ›´æ–°...');

                const response = await fetch(`${url}/rest/v1/users?id=eq.${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        auto_digest_enabled: true,
                        auto_digest_time: '10:00:00',
                        auto_digest_timezone: 'UTC',
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog('debugLog', `æ›´æ–°å¤±è´¥: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addLog('debugLog', `æ›´æ–°å“åº”: ${JSON.stringify(result, null, 2)}`);
                
                showStatus('debugStatus', 'success', 'âœ… ç›´æ¥æ›´æ–°æˆåŠŸ');

            } catch (error) {
                showStatus('debugStatus', 'error', `âŒ ç›´æ¥æ›´æ–°å¤±è´¥: ${error.message}`);
                addLog('debugLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // éªŒè¯æ›´æ–°ç»“æœ
        window.verifyUpdate = async function() {
            addLog('debugLog', '\n--- éªŒè¯æ›´æ–°ç»“æœ ---');
            // é‡ç”¨æ£€æŸ¥å½“å‰å€¼çš„é€»è¾‘
            await checkCurrentValue();
        };
    </script>
</body>
</html> 