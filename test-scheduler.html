<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª æµ‹è¯•Auto Digestè°ƒåº¦å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #cce7ff; color: #004085; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .highlight {
            background: #ffffcc;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Auto Digestè°ƒåº¦å™¨æµ‹è¯•å·¥å…·</h1>
    <p>æµ‹è¯•ä½ çš„Edge Functionæ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ</p>

    <!-- é…ç½® -->
    <div class="test-panel">
        <h3>âš™ï¸ é…ç½®</h3>
        <div class="form-group">
            <label>Supabase URL:</label>
            <input type="text" id="supabaseUrl" value="https://ryncyvnezqwqqtfsweti.supabase.co">
        </div>
        <div class="form-group">
            <label>Service Role Key:</label>
            <input type="password" id="serviceKey" placeholder="ç”¨äºè°ƒç”¨Edge Function">
        </div>
    </div>

    <!-- å¿«é€Ÿæµ‹è¯• -->
    <div class="test-panel">
        <h3>âš¡ å¿«é€Ÿæµ‹è¯•</h3>
        <p>ç«‹å³æµ‹è¯•ä½ çš„è°ƒåº¦å™¨æ˜¯å¦å·¥ä½œ</p>
        <button onclick="testSchedulerNow()">ğŸš€ æµ‹è¯•è°ƒåº¦å™¨ç°åœ¨</button>
        <button onclick="forceRunDigest()">ğŸ’ª å¼ºåˆ¶è¿è¡ŒDigest (å¿½ç•¥æ—¶é—´)</button>
        <div id="quickStatus" class="status" style="display: none;"></div>
        <div id="quickLog" class="log" style="display: none;"></div>
    </div>

    <!-- æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ -->
    <div class="test-panel">
        <h3>ğŸ‘¤ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</h3>
        <p>æŸ¥çœ‹å“ªäº›ç”¨æˆ·ç¬¦åˆauto digestæ¡ä»¶</p>
        <button onclick="checkEligibleUsers()">ğŸ“Š æŸ¥çœ‹ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·</button>
        <button onclick="checkCurrentTime()">ğŸ•’ æŸ¥çœ‹å½“å‰UTCæ—¶é—´</button>
        <div id="userStatus" class="status" style="display: none;"></div>
        <div id="userLog" class="log" style="display: none;"></div>
    </div>

    <!-- è®¾ç½®å¤–éƒ¨è°ƒåº¦ -->
    <div class="test-panel">
        <h3>ğŸŒ è®¾ç½®è‡ªåŠ¨è°ƒåº¦</h3>
        <p>è·å–è®¾ç½®å¤–éƒ¨CronæœåŠ¡çš„ä¿¡æ¯</p>
        <button onclick="generateCronInfo()">ğŸ“‹ ç”ŸæˆCron Jobé…ç½®</button>
        <div id="cronStatus" class="status" style="display: none;"></div>
        <div id="cronLog" class="log" style="display: none;"></div>
    </div>

    <script>
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function addLog(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.textContent += `[${timestamp}] ${message}\n`;
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // æµ‹è¯•è°ƒåº¦å™¨
        window.testSchedulerNow = async function() {
            clearLog('quickLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                if (!serviceKey) {
                    throw new Error('è¯·å¡«å†™Service Role Key');
                }

                addLog('quickLog', 'è°ƒç”¨auto-digest-scheduler Edge Function...');
                addLog('quickLog', `URL: ${url}/functions/v1/auto-digest-scheduler`);

                const response = await fetch(`${url}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test: true,
                        source: 'manual-test'
                    })
                });

                addLog('quickLog', `å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    addLog('quickLog', `é”™è¯¯å“åº”: ${errorText}`);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                addLog('quickLog', `æˆåŠŸå“åº”: ${JSON.stringify(result, null, 2)}`);

                if (result.success) {
                    showStatus('quickStatus', 'success', 'ğŸ‰ è°ƒåº¦å™¨æµ‹è¯•æˆåŠŸ!');
                    addLog('quickLog', `ç¬¦åˆæ¡ä»¶ç”¨æˆ·: ${result.eligible_users || 0}`);
                    addLog('quickLog', `å¤„ç†ç”¨æˆ·: ${result.processed_users || 0}`);
                } else {
                    showStatus('quickStatus', 'warning', 'âš ï¸ è°ƒåº¦å™¨è¿è¡Œä½†æœ‰é—®é¢˜');
                }

            } catch (error) {
                showStatus('quickStatus', 'error', `âŒ è°ƒåº¦å™¨æµ‹è¯•å¤±è´¥: ${error.message}`);
                addLog('quickLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // å¼ºåˆ¶è¿è¡Œ
        window.forceRunDigest = async function() {
            addLog('quickLog', '\n--- å¼ºåˆ¶è¿è¡Œæ¨¡å¼ ---');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                addLog('quickLog', 'å¼ºåˆ¶è¿è¡Œauto digest (å¿½ç•¥æ—¶é—´æ¡ä»¶)...');

                const response = await fetch(`${url}/functions/v1/auto-digest-scheduler`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        force: true,
                        ignoreTime: true,
                        source: 'manual-force'
                    })
                });

                const result = await response.json();
                addLog('quickLog', `å¼ºåˆ¶è¿è¡Œç»“æœ: ${JSON.stringify(result, null, 2)}`);

                if (response.ok && result.success) {
                    showStatus('quickStatus', 'success', 'ğŸ’ª å¼ºåˆ¶è¿è¡ŒæˆåŠŸ!');
                } else {
                    showStatus('quickStatus', 'warning', 'âš ï¸ å¼ºåˆ¶è¿è¡Œæœ‰é—®é¢˜');
                }

            } catch (error) {
                addLog('quickLog', `å¼ºåˆ¶è¿è¡Œé”™è¯¯: ${error.message}`);
            }
        };

        // æ£€æŸ¥ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·
        window.checkEligibleUsers = async function() {
            clearLog('userLog');
            try {
                const url = document.getElementById('supabaseUrl').value;
                const serviceKey = document.getElementById('serviceKey').value;

                addLog('userLog', 'æŸ¥è¯¢ç¬¦åˆauto digestæ¡ä»¶çš„ç”¨æˆ·...');

                // æŸ¥è¯¢æ•°æ®åº“
                const query = `
                    WITH current_time AS (
                        SELECT 
                            EXTRACT(HOUR FROM NOW() AT TIME ZONE 'UTC') as hour,
                            EXTRACT(MINUTE FROM NOW() AT TIME ZONE 'UTC') as minute
                    )
                    SELECT 
                        u.id,
                        u.email,
                        u.auto_digest_enabled,
                        u.auto_digest_time,
                        EXTRACT(HOUR FROM u.auto_digest_time) as setting_hour,
                        EXTRACT(MINUTE FROM u.auto_digest_time) as setting_minute,
                        u.last_auto_digest_run,
                        CASE 
                            WHEN u.last_auto_digest_run::date = CURRENT_DATE THEN true
                            ELSE false
                        END as ran_today,
                        ABS(EXTRACT(MINUTE FROM u.auto_digest_time) - ct.minute) as minute_diff
                    FROM users u, current_time ct
                    WHERE u.auto_digest_enabled = true
                    ORDER BY minute_diff
                `;

                const response = await fetch(`${url}/rest/v1/rpc/query_users_auto_digest`, {
                    method: 'POST',
                    headers: {
                        'apikey': serviceKey,
                        'Authorization': `Bearer ${serviceKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    // å°è¯•ç›´æ¥æŸ¥è¯¢usersè¡¨
                    const usersResponse = await fetch(`${url}/rest/v1/users?select=id,email,auto_digest_enabled,auto_digest_time,last_auto_digest_run&auto_digest_enabled=eq.true`, {
                        headers: {
                            'apikey': serviceKey,
                            'Authorization': `Bearer ${serviceKey}`
                        }
                    });

                    if (usersResponse.ok) {
                        const users = await usersResponse.json();
                        const now = new Date();
                        const currentHour = now.getUTCHours();
                        const currentMinute = now.getUTCMinutes();

                        addLog('userLog', `å½“å‰UTCæ—¶é—´: ${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`);
                        addLog('userLog', `æ‰¾åˆ° ${users.length} ä¸ªå¯ç”¨auto digestçš„ç”¨æˆ·:\n`);

                        users.forEach((user, index) => {
                            const timeStr = user.auto_digest_time || '09:00:00';
                            const [hour, minute] = timeStr.split(':').map(Number);
                            const timeDiff = Math.abs(minute - currentMinute);
                            const hourMatch = hour === currentHour;
                            const withinWindow = timeDiff <= 2;
                            const ranToday = user.last_auto_digest_run && 
                                new Date(user.last_auto_digest_run).toDateString() === new Date().toDateString();

                            addLog('userLog', `ç”¨æˆ· ${index + 1}: ${user.email || user.id}`);
                            addLog('userLog', `  è®¾ç½®æ—¶é—´: ${timeStr}`);
                            addLog('userLog', `  æ—¶é—´åŒ¹é…: ${hourMatch ? 'âœ…' : 'âŒ'} å°æ—¶, ${withinWindow ? 'âœ…' : 'âŒ'} åˆ†é’Ÿçª—å£`);
                            addLog('userLog', `  ä»Šæ—¥å·²è¿è¡Œ: ${ranToday ? 'âœ…' : 'âŒ'}`);
                            addLog('userLog', `  ç¬¦åˆæ¡ä»¶: ${hourMatch && withinWindow && !ranToday ? 'ğŸ¯ æ˜¯' : 'âŒ å¦'}\n`);
                        });

                        showStatus('userStatus', 'success', 'âœ… ç”¨æˆ·çŠ¶æ€æ£€æŸ¥å®Œæˆ');
                    } else {
                        throw new Error('æ— æ³•æŸ¥è¯¢ç”¨æˆ·æ•°æ®');
                    }
                } else {
                    const result = await response.json();
                    addLog('userLog', `æŸ¥è¯¢ç»“æœ: ${JSON.stringify(result, null, 2)}`);
                }

            } catch (error) {
                showStatus('userStatus', 'error', `âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                addLog('userLog', `é”™è¯¯: ${error.message}`);
            }
        };

        // æ£€æŸ¥å½“å‰æ—¶é—´
        window.checkCurrentTime = async function() {
            addLog('userLog', '\n--- å½“å‰æ—¶é—´ä¿¡æ¯ ---');
            const now = new Date();
            addLog('userLog', `æœ¬åœ°æ—¶é—´: ${now.toLocaleString()}`);
            addLog('userLog', `UTCæ—¶é—´: ${now.toISOString()}`);
            addLog('userLog', `UTCå°æ—¶: ${now.getUTCHours()}`);
            addLog('userLog', `UTCåˆ†é’Ÿ: ${now.getUTCMinutes()}`);
        };

        // ç”ŸæˆCroné…ç½®
        window.generateCronInfo = async function() {
            clearLog('cronLog');
            const url = document.getElementById('supabaseUrl').value;
            const serviceKey = document.getElementById('serviceKey').value;

            if (!serviceKey) {
                showStatus('cronStatus', 'warning', 'âš ï¸ è¯·å…ˆå¡«å†™Service Role Key');
                return;
            }

            addLog('cronLog', 'ğŸŒ å¤–éƒ¨CronæœåŠ¡é…ç½®ä¿¡æ¯:\n');
            
            addLog('cronLog', '=== cron-job.org é…ç½® ===');
            addLog('cronLog', `URL: ${url}/functions/v1/auto-digest-scheduler`);
            addLog('cronLog', 'Method: POST');
            addLog('cronLog', 'Schedule: */5 * * * * (æ¯5åˆ†é’Ÿ)');
            addLog('cronLog', 'Headers:');
            addLog('cronLog', `  Authorization: Bearer ${serviceKey.substring(0, 20)}...`);
            addLog('cronLog', '  Content-Type: application/json');
            addLog('cronLog', 'Body:');
            addLog('cronLog', '  {"source": "cron-job"}\n');

            addLog('cronLog', '=== GitHub Actions é…ç½® ===');
            addLog('cronLog', 'æ–‡ä»¶è·¯å¾„: .github/workflows/auto-digest.yml');
            addLog('cronLog', 'éœ€è¦è®¾ç½®Secret: SUPABASE_SERVICE_ROLE_KEY\n');

            addLog('cronLog', '=== æµ‹è¯•å‘½ä»¤ ===');
            addLog('cronLog', `curl -X POST \\`);
            addLog('cronLog', `  -H "Authorization: Bearer ${serviceKey.substring(0, 20)}..." \\`);
            addLog('cronLog', `  -H "Content-Type: application/json" \\`);
            addLog('cronLog', `  -d '{"test": true}' \\`);
            addLog('cronLog', `  ${url}/functions/v1/auto-digest-scheduler`);

            showStatus('cronStatus', 'info', 'ğŸ“‹ é…ç½®ä¿¡æ¯å·²ç”Ÿæˆ');
        };
    </script>
</body>
</html> 